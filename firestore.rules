rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and write their own user documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Courses collection
    match /courses/{courseId} {
      // Anyone can read active courses
      allow read: if resource.data.isActive == true;

      // Only lecturers can create courses
      allow create: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'lecturer';

      // Only course lecturer can update/delete their courses
      allow update, delete: if request.auth != null &&
        request.auth.uid == resource.data.lecturerId;
    }

    // Course participants subcollection
    match /courses/{courseId}/participants/{participantId} {
      // Users can read participants of courses they have access to
      allow read: if request.auth != null &&
        (request.auth.uid == participantId ||
         exists(/databases/$(database)/documents/courses/$(courseId)) &&
         get(/databases/$(database)/documents/courses/$(courseId)).data.isActive == true);

      // Users can join/leave courses (create/delete their own participant document)
      allow create: if request.auth != null &&
        request.auth.uid == participantId &&
        exists(/databases/$(database)/documents/courses/$(courseId)) &&
        get(/databases/$(database)/documents/courses/$(courseId)).data.isActive == true;

      allow delete: if request.auth != null &&
        request.auth.uid == participantId;
    }

    // Materials subcollection
    match /courses/{courseId}/materials/{materialId} {
      // Participants and lecturers can read materials
      allow read: if request.auth != null &&
        (exists(/databases/$(database)/documents/courses/$(courseId)/participants/$(request.auth.uid)) ||
         get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid);

      // Only lecturers can create/update/delete materials
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid;
    }

    // Assignments subcollection
    match /courses/{courseId}/assignments/{assignmentId} {
      // Participants and lecturers can read assignments
      allow read: if request.auth != null &&
        (exists(/databases/$(database)/documents/courses/$(courseId)/participants/$(request.auth.uid)) ||
         get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid);

      // Only lecturers can create/update/delete assignments
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid;
    }

    // Assignment submissions subcollection
    match /courses/{courseId}/assignments/{assignmentId}/submissions/{submissionId} {
      // Students can read/write their own submissions, lecturers can read all
      allow read: if request.auth != null &&
        (request.auth.uid == submissionId ||
         get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid);

      allow write: if request.auth != null &&
        request.auth.uid == submissionId;
    }

    // Quizzes subcollection
    match /courses/{courseId}/quizzes/{quizId} {
      // Participants and lecturers can read quizzes
      allow read: if request.auth != null &&
        (exists(/databases/$(database)/documents/courses/$(courseId)/participants/$(request.auth.uid)) ||
         get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid);

      // Only lecturers can create/update/delete quizzes
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid;
    }

    // Quiz attempts subcollection
    match /courses/{courseId}/quizzes/{quizId}/attempts/{attemptId} {
      // Students can read/write their own attempts, lecturers can read all
      allow read: if request.auth != null &&
        (request.auth.uid == attemptId ||
         get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid);

      allow write: if request.auth != null &&
        request.auth.uid == attemptId;
    }

    // Forum posts subcollection
    match /courses/{courseId}/forum/{postId} {
      // Participants and lecturers can read/write forum posts
      allow read, write: if request.auth != null &&
        (exists(/databases/$(database)/documents/courses/$(courseId)/participants/$(request.auth.uid)) ||
         get(/databases/$(database)/documents/courses/$(courseId)).data.lecturerId == request.auth.uid);
    }
  }
}